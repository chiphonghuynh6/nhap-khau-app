<!DOCTYPE html>

<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω nh·∫≠p kh·∫©u</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
  .editing-row {
    background-color: #FEF9C3; /* m√†u v√†ng nh·∫°t */
  }
</style>
</head>
<body class="bg-gray-50 p-4">
  <div class="max-w-6xl mx-auto bg-white p-4 rounded-lg shadow">
    <h1 class="text-xl font-semibold mb-4">Form Nh·∫≠p Li·ªáu</h1>
<!-- Form nh·∫≠p li·ªáu -->
<form id="importForm" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">

  <!-- Th√¥ng tin chung -->

  <fieldset class="border p-4 space-y-2">
    <legend class="font-semibold">Th√¥ng tin chung</legend>

<div>
  <label class="block font-medium mb-1">GET DOCS</label>
  <input type="date" name="GET DOCS" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">DEC NO</label>
  <input type="text" name="DEC NO" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">FACT NO</label>
  <select name="FACT NO" class="w-full border rounded px-2 py-1">
    <option></option>
    <option>18A</option>
    <option>B0SZ</option>
    <option>B0M1</option>
    <option>B0M2</option>
  </select>
</div>

<div>
  <label class="block font-medium mb-1">LO·∫†I H√åNH</label>
  <select name="LO·∫†I H√åNH" class="w-full border rounded px-2 py-1">
    <option></option>
    <option>A12</option>
    <option>E21</option>
    <option>H11</option>
  </select>
</div>

<div>
  <label class="block font-medium mb-1">FWD</label>
  <input type="text" name="FWD" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">SUPPLIER</label>
  <input type="text" name="SUPPLIER" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">TYPE</label>
  <select name="TYPE" class="w-full border rounded px-2 py-1">
    <option></option>
    <option>CONT</option>
    <option>CFS</option>
    <option>NGOAI QUAN</option>
    <option>BY TRUCK</option>
    <option>DHL</option>
    <option>AIR</option>
  </select>
</div>

<div>
  <label class="block font-medium mb-1">ORIGIN</label>
  <input type="text" name="ORIGIN" class="w-full border rounded px-2 py-1"/>
</div>

  </fieldset>

  <!-- Th√¥ng tin v·∫≠n ƒë∆°n -->

  <fieldset class="border p-4 space-y-2">
    <legend class="font-semibold">Th√¥ng tin v·∫≠n ƒë∆°n</legend>

<div>
  <label class="block font-medium mb-1">BILL NO</label>
  <input type="text" name="BILL NO" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">BILL DATE</label>
  <input type="date" name="BILL DATE" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">PACKAGES</label>
  <input type="number" name="PACKAGES" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">GW</label>
  <input type="number" name="GW" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">CBM</label>
  <input type="number" name="CBM" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">CTN NO</label>
  <input type="text" name="CTN NO" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">ETA DATE</label>
  <input type="date" name="ETA DATE" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">ATC</label>
  <input type="date" name="ATC" class="w-full border rounded px-2 py-1"/>
</div>

  </fieldset>

  <!-- Th√¥ng tin h√≥a ƒë∆°n -->

  <fieldset class="border p-4 space-y-2">
    <legend class="font-semibold">Th√¥ng tin h√≥a ƒë∆°n</legend>

<div>
  <label class="block font-medium mb-1">INV NO</label>
  <input type="text" name="INV NO" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">INV DATE</label>
  <input type="date" name="INV DATE" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">AMOUNT</label>
  <input type="text" name="AMOUNT" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">TERM</label>
  <select name="TERM" class="w-full border rounded px-2 py-1">
    <option></option>
    <option>CIF</option>
    <option>FOB</option>
    <option>C&F</option>
    <option>FCA</option>
    <option>EXW</option>
    <option>CPT</option>
    <option>DAT</option>
    <option>DAP</option>
    <option>CIP</option>
  </select>
</div>

<div>
  <label class="block font-medium">File PDF</label>
  <input type="file" id="pdfFile" class="w-full border rounded px-2 py-1"/>
</div>

  </fieldset>

  <!-- N√∫t Th√™m -->

  <div class="md:col-span-3">
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded w-full md:w-auto">
      L∆∞u
    </button>
   </div>
</form>

<!-- Th√¥ng b√°o k·∫øt qu·∫£ -->
<div id="addResult" class="mt-4 hidden bg-green-50 border border-green-400 p-4 rounded text-green-700"></div>

<!-- N√∫t xem b·∫£ng v√† export -->
<div class="mt-2 hidden" id="showTableBtn">
  <button onclick="showTable()" class="text-blue-600 underline hover:text-blue-800">üëâ Xem to√†n b·ªô danh s√°ch l√¥ h√†ng</button>
</div>

<div class="mt-4 flex flex-wrap gap-2">
  <button onclick="exportCsv()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">üì§ Xu·∫•t to√†n b·ªô CSV</button>
  <button onclick="exportAtcEmptyCsv()" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">üì§ Xu·∫•t ATC tr·ªëng CSV</button>
</div>
    
  <!-- T√¨m ki·∫øm -->
    <div class="mt-4 flex items-center gap-2">
      <label for="searchDecNo" class="font-medium">T√¨m theo DEC NO:</label>
      <input id="searchDecNo" type="text" placeholder="Nh·∫≠p DEC NO..." class="p-2 border border-gray-400 rounded w-full md:w-1/3" oninput="filterTableByDecNo()">
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
  <input type="text" id="searchSupplier" placeholder="Nh√† cung c·∫•p (SUPPLIER)" class="input input-bordered w-full" />
  <input type="text" id="searchFWD" placeholder="FWD" class="input input-bordered w-full" />
  <input type="date" id="searchETADateFrom" class="input input-bordered w-full" />
  <input type="date" id="searchETADateTo" class="input input-bordered w-full" />
</div>
<button onclick="applyAdvancedFilter()" class="btn btn-primary mb-4">L·ªçc d·ªØ li·ªáu</button>
    <button onclick="resetFilter()" class="btn btn-secondary mb-4 ml-2">X√≥a l·ªçc</button>


    
    <!-- B·∫£ng d·ªØ li·ªáu -->
    <div id="dataTable" class="overflow-x-auto mt-6 bg-white rounded shadow p-4"></div>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz-xW0HzV0TCkS3dh9kl6fcExPsOMLZAjJTAxkRwIdYhbVoF5WPAVGF9xUD2SaHf08HFA/exec";
let data = [];
let editingIndex = -1;

// L·∫•y d·ªØ li·ªáu t·ª´ Google Sheets
async function fetchData() {
  const res = await fetch(API_URL);
  const result = await res.json();
  data = result.data || [];
  renderTable(data);
}
fetchData();

// Hi·ªÉn th·ªã d·ªØ li·ªáu ra b·∫£ng
function renderTable(dataArray) {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";

  dataArray.forEach((row, index) => {
    const tr = document.createElement("tr");
    tr.className = "border-b";
    row.forEach(cell => {
      const td = document.createElement("td");
      td.className = "p-2 border";
      td.textContent = cell;
      tr.appendChild(td);
    });

    // Th√™m n√∫t S·ª≠a / Xo√°
    const actionsTd = document.createElement("td");
    actionsTd.className = "p-2 flex space-x-2";
    actionsTd.innerHTML = `
      <button onclick="editRow(${index})" class="text-blue-600">S·ª≠a</button>
      <button onclick="deleteRow(${index})" class="text-red-600">Xo√°</button>
    `;
    tr.appendChild(actionsTd);

    tbody.appendChild(tr);
  });
}

// T√¨m ki·∫øm d·ªØ li·ªáu
document.getElementById("searchInput").addEventListener("input", function () {
  const search = this.value.toLowerCase();
  const filtered = data.filter(row =>
    row[2].toLowerCase().includes(search) ||  // DEC NO
    row[13].toLowerCase().includes(search) || // SUPPLIER
    row[5].toLowerCase().includes(search) ||  // FWD
    row[17].toLowerCase().includes(search)    // ETA DATE
  );
  renderTable(filtered);
});

// Export CSV
function exportCSV(dataArray, filename = "export.csv") {
  const csv = dataArray.map(row => row.map(cell => `"${cell}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}

document.getElementById("exportBtn").addEventListener("click", () => exportCSV(data));
document.getElementById("exportATCBtn").addEventListener("click", () => {
  const filtered = data.filter(row => !row[19]); // ATC tr·ªëng
  exportCSV(filtered, "export-atc-trong.csv");
});

// G·ª≠i d·ªØ li·ªáu th√™m m·ªõi ho·∫∑c c·∫≠p nh·∫≠t
document.getElementById("importForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const formData = new FormData(this);
  const obj = {};
  formData.forEach((value, key) => obj[key] = value);

  if (editingIndex === -1) {
    // Th√™m m·ªõi
    obj.method = "add";
  } else {
    // C·∫≠p nh·∫≠t
    obj.method = "update";
    obj.rowIndex = editingIndex + 2;
  }

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(obj),
    headers: {
      "Content-Type": "application/json",
    },
  });

  const result = await res.json();
  alert(result.message || "Th√†nh c√¥ng!");
  this.reset();
  editingIndex = -1;
  fetchData();
});

// S·ª≠a d·ªØ li·ªáu
function editRow(index) {
  const row = data[index];
  const form = document.getElementById("importForm");
  const inputs = form.querySelectorAll("input, textarea, select");
  const keys = [
    "getdocs", "factno", "decno", "loaihinh", "type", "fwd", "billno", "billdate",
    "packages", "gw", "cbm", "ctnno", "pkgwcbm", "origin", "supplier", "invno",
    "invdate", "amount", "term", "etadate", "atc", "remarks", "blfact"
  ];

  inputs.forEach((input, i) => {
    let value = row[i] || "";
    if (input.type === "date" && value.includes("/")) {
      const parts = value.split("/");
      const [day, month, year] = parts;
      if (year.length === 4 && month.length <= 2 && day.length <= 2) {
        value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
      }
    }
    input.value = value;
  });

  editingIndex = index;
  window.scrollTo({ top: 0, behavior: "smooth" });
}

// Xo√° d·ªØ li·ªáu
async function deleteRow(index) {
  if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° d√≤ng n√†y?")) return;

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ method: "delete", rowIndex: index + 2 }),
    headers: {
      "Content-Type": "application/json",
    },
  });

  const result = await res.json();
  alert(result.message || "ƒê√£ xo√°.");
  fetchData();
}
</script>

</body>
</html>
