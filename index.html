<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω nh·∫≠p kh·∫©u</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .editing-row {
      background-color: #FEF9C3; /* m√†u v√†ng nh·∫°t */
    }
  </style>
</head>
<body class="bg-gray-50 p-4">
  <div class="max-w-6xl mx-auto bg-white p-4 rounded-lg shadow">
    <h1 class="text-xl font-semibold mb-4">Th√¥ng tin h√†ng nh·∫≠p</h1>

    <!-- N√∫t Th√™m -->
    <div class="mb-4">
      <button id="addNewBtn" type="button" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
        ‚ûï Th√™m m·ªõi
      </button>
    </div>
    <!-- Form nh·∫≠p li·ªáu -->
    <form id="importForm" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">

      <!-- Th√¥ng tin chung -->
      <fieldset class="border p-4 space-y-2">
        <legend class="font-semibold">Th√¥ng tin chung</legend>

        <div>
          <label class="block font-medium mb-1">GET_DOCS</label>
          <input type="date" name="GET_DOCS" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">DEC_NO</label>
          <input type="text" name="DEC_NO" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">FACT_NO</label>
          <select name="FACT_NO" class="w-full border rounded px-2 py-1">
            <option></option>
            <option>18A</option>
            <option>B0SZ</option>
            <option>B0M1</option>
            <option>B0M2</option>
          </select>
        </div>
        <div>
          <label class="block font-medium mb-1">LOAI_HINH</label>
          <select name="LOAI_HINH" class="w-full border rounded px-2 py-1">
            <option></option>
            <option>A12</option>
            <option>E21</option>
            <option>H11</option>
          </select>
        </div>
        <div>
          <label class="block font-medium mb-1">FWD</label>
          <input type="text" name="FWD" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">SUPPLIER</label>
          <input type="text" name="SUPPLIER" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">TYPE</label>
          <select name="TYPE" class="w-full border rounded px-2 py-1">
            <option></option>
            <option>CONT</option>
            <option>CFS</option>
            <option>NGOAI_QUAN</option>
            <option>BY_TRUCK</option>
            <option>DHL</option>
            <option>AIR</option>
          </select>
        </div>
        <div>
          <label class="block font-medium mb-1">ORIGIN</label>
          <input type="text" name="ORIGIN" class="w-full border rounded px-2 py-1"/>
        </div>
      </fieldset>

      <!-- Th√¥ng tin v·∫≠n ƒë∆°n -->
      <fieldset class="border p-4 space-y-2">
        <legend class="font-semibold">Th√¥ng tin v·∫≠n ƒë∆°n</legend>

        <div>
          <label class="block font-medium mb-1">BILL_NO</label>
          <input type="text" name="BILL_NO" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">BILL_DATE</label>
          <input type="date" name="BILL_DATE" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">PACKAGES</label>
          <input type="number" name="PACKAGES" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">GW</label>
          <input type="number" name="GW" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">CBM</label>
          <input type="number" name="CBM" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">CTN_NO</label>
          <input type="text" name="CTN_NO" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">ETA_DATE</label>
          <input type="date" name="ETA_DATE" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">ATC</label>
          <input type="date" name="ATC" class="w-full border rounded px-2 py-1"/>
        </div>
      </fieldset>

      <!-- Th√¥ng tin h√≥a ƒë∆°n -->
      <fieldset class="border p-4 space-y-2">
        <legend class="font-semibold">Th√¥ng tin h√≥a ƒë∆°n</legend>

        <div>
          <label class="block font-medium mb-1">INV_NO</label>
          <input type="text" name="INV_NO" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">INV_DATE</label>
          <input type="date" name="INV_DATE" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">AMOUNT</label>
          <input type="text" name="AMOUNT" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">TERM</label>
          <select name="TERM" class="w-full border rounded px-2 py-1">
            <option></option>
            <option>CIF</option>
            <option>FOB</option>
            <option>C&F</option>
            <option>FCA</option>
            <option>EXW</option>
            <option>CPT</option>
            <option>DAT</option>
            <option>DAP</option>
            <option>CIP</option>
          </select>
        </div>
        <div>
          <label class="block font-medium">File PDF</label>
          <input type="file" id="pdfFile" name="pdfFile" class="w-full border rounded px-2 py-1"/>
        </div>
      </fieldset>

      <div class="md:col-span-3">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded w-full md:w-auto">
          L∆∞u
        </button>
      </div>
    </form>

    <!-- Th√¥ng b√°o k·∫øt qu·∫£ -->
    <div id="addResult" class="mt-4 hidden bg-green-50 border border-green-400 p-4 rounded text-green-700"></div>

    <!-- N√∫t xem b·∫£ng v√† export -->
    <div class="mt-2" id="showTableBtn">
      <button onclick="showTable()" class="text-blue-600 underline hover:text-blue-800">üëâ Xem to√†n b·ªô danh s√°ch l√¥ h√†ng</button>
    </div>

    <div class="mt-4 flex flex-wrap gap-2">
      <button onclick="exportCsv()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">üì§ Xu·∫•t to√†n b·ªô CSV</button>
      <button onclick="exportAtcEmptyCsv()" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">üì§ Xu·∫•t ATC tr·ªëng CSV</button>
    </div>
    
    <!-- T√¨m ki·∫øm -->
    <div class="my-4">
  <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm..." class="border px-2 py-1 rounded w-full md:w-1/3">
</div>

    
    <!-- B·∫£ng d·ªØ li·ªáu -->
    <div id="dataTable" class="overflow-x-auto mt-6 bg-white rounded shadow p-4">
  <table class="min-w-full text-sm text-left border">
    <thead class="bg-gray-100 font-semibold">
      <tr>
        <th class="border px-2 py-1">GET_DOCS</th>
        <th class="border px-2 py-1">DEC_NO</th>
        <th class="border px-2 py-1">FACT_NO</th>
        <th class="border px-2 py-1">LOAI_HINH</th>
        <th class="border px-2 py-1">TYPE</th>
        <th class="border px-2 py-1">FWD</th>
        <th class="border px-2 py-1">SUPPLIER</th>
        <th class="border px-2 py-1">ORIGIN</th>
        <th class="border px-2 py-1">BILL_NO</th>
        <th class="border px-2 py-1">BILL_DATE</th>
        <th class="border px-2 py-1">PACKAGES</th>
        <th class="border px-2 py-1">GW</th>
        <th class="border px-2 py-1">CBM</th>
        <th class="border px-2 py-1">CTN_NO</th>
        <th class="border px-2 py-1">ETA_DATE</th>
        <th class="border px-2 py-1">ATC</th>
        <th class="border px-2 py-1">INV_NO</th>
        <th class="border px-2 py-1">INV_DATE</th>
        <th class="border px-2 py-1">AMOUNT</th>
        <th class="border px-2 py-1">TERM</th>
        <th class="border px-2 py-1">Remarks</th>
        <th class="border px-2 py-1">Actions</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n t·∫°i ƒë√¢y -->
    </tbody>
  </table>
</div>


<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyyvPf2hF9SQE8LsIZzvdPpJO4EiMc9iSw1SKvy25_WjLrKoCZNXd5_X8dqf16Y1Z-n/exec";
let editingIndex = null;

// G·ª≠i form th√™m ho·∫∑c c·∫≠p nh·∫≠t d·ªØ li·ªáu
document.getElementById("importForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const formData = new FormData(this);
  const data = {};
  formData.forEach((value, key) => data[key] = value);

  if (editingIndex !== null) {
    data.index = editingIndex;
  }

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(data),
      headers: { "Content-Type": "application/json" }
    });

    if (!res.ok) throw new Error("L·ªói m·∫°ng");

    document.getElementById("addResult").textContent = "‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu!";
    document.getElementById("addResult").classList.remove("hidden");
    this.reset();
    editingIndex = null;
    showData();
  } catch (error) {
    alert("‚ùå L·ªói khi g·ª≠i d·ªØ li·ªáu: " + error.message);
  }
});

// Hi·ªÉn th·ªã d·ªØ li·ªáu t·ª´ Google Sheets
async function showData() {
  const res = await fetch(API_URL);
  const rows = await res.json();

  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];
    const tr = document.createElement("tr");

    row.forEach(cell => {
      const td = document.createElement("td");
      td.className = "border px-2 py-1 text-sm";
      td.textContent = cell;
      tr.appendChild(td);
    });

    // Th√™m n√∫t s·ª≠a / xo√°
    const tdAction = document.createElement("td");
    tdAction.className = "border px-2 py-1 text-sm";
    tdAction.innerHTML = `
      <button class="text-blue-500 underline mr-2" onclick="editRow(${i})">S·ª≠a</button>
      <button class="text-red-500 underline" onclick="deleteRow(${i})">Xo√°</button>
    `;
    tr.appendChild(tdAction);
    tbody.appendChild(tr);
  }
}

// T√¨m ki·∫øm theo DEC NO ho·∫∑c FACT NO
document.getElementById("searchInput").addEventListener("input", function () {
  const value = this.value.toLowerCase();
  const rows = document.querySelectorAll("#tableBody tr");

  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(value) ? "" : "none";
  });
});

// S·ª≠a d√≤ng
async function editRow(index) {
  const res = await fetch(API_URL);
  const rows = await res.json();
  const row = rows[index];
  const fields = document.querySelectorAll("#importForm input, #importForm select");

  fields.forEach((field, i) => {
    if (row[i] !== undefined) field.value = row[i];
  });

  editingIndex = index;
  document.getElementById("addResult").textContent = "üìù ƒêang s·ª≠a d√≤ng #" + index;
  document.getElementById("addResult").classList.remove("hidden");
}

// Xo√° d√≤ng
async function deleteRow(index) {
  if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° d√≤ng n√†y?")) return;

  try {
    const res = await fetch(API_URL + `?delete=${index}`, { method: "GET" });
    if (!res.ok) throw new Error("Kh√¥ng th·ªÉ xo√°");
    showData();
  } catch (err) {
    alert("‚ùå Xo√° th·∫•t b·∫°i: " + err.message);
  }
}

// Xu·∫•t CSV
async function exportCsv(filterAtcEmpty = false) {
  const res = await fetch(API_URL);
  const rows = await res.json();

  let csvContent = rows
    .filter((row, i) => {
      if (i === 0) return true;
      return !filterAtcEmpty || row[21] === ""; // C·ªôt ATC
    })
    .map(e => e.map(v => `"${v}"`).join(","))
    .join("\n");

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  link.download = filterAtcEmpty ? "atc_empty_data.csv" : "all_data.csv";
  link.click();
}

// G·ªçi khi trang load
document.addEventListener("DOMContentLoaded", showData);
</script>

</body>
</html>
