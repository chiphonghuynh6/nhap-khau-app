<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω nh·∫≠p kh·∫©u</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-screen-xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">Qu·∫£n l√Ω nh·∫≠p kh·∫©u</h1>

    <!-- Form nh·∫≠p li·ªáu -->
    <form id="importForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-white p-4 rounded shadow">
      <!-- V√≠ d·ª• 1 v√†i tr∆∞·ªùng, b·∫°n th√™m ƒë·∫ßy ƒë·ªß theo form c·ªßa b·∫°n -->
      <fieldset class="border p-4 space-y-2">
        <legend class="font-semibold">Th√¥ng tin</legend>

        <div><label class="block">DEC NO</label><input type="text" name="DEC NO" class="w-full p-2 border rounded" /></div>
        <div><label class="block">FACT NO</label><input type="text" name="FACT NO" class="w-full p-2 border rounded" /></div>
        <div><label class="block">ATC</label><input type="date" name="ATC" class="w-full p-2 border rounded" /></div>
        <div><label class="block">AMOUNT</label><input type="number" name="AMOUNT" class="w-full p-2 border rounded" /></div>
      </fieldset>

      <div class="md:col-span-3">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded w-full md:w-auto">
          Th√™m l√¥ m·ªõi
        </button>
      </div>
    </form>

    <!-- Th√¥ng b√°o k·∫øt qu·∫£ -->
    <div id="addResult" class="mt-4 hidden bg-green-50 border border-green-400 p-4 rounded text-green-700"></div>

    <!-- N√∫t xem b·∫£ng v√† export -->
    <div class="mt-2 hidden" id="showTableBtn">
      <button onclick="showTable()" class="text-blue-600 underline hover:text-blue-800">üëâ Xem to√†n b·ªô danh s√°ch l√¥ h√†ng</button>
    </div>

    <div class="mt-4 flex flex-wrap gap-2">
      <button onclick="exportCsv()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">üì§ Xu·∫•t to√†n b·ªô CSV</button>
      <button onclick="exportAtcEmptyCsv()" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">üì§ Xu·∫•t ATC tr·ªëng CSV</button>
    </div>
<div class="mt-4 flex items-center gap-2">
  <label for="searchDecNo" class="font-medium">T√¨m theo DEC NO:</label>
  <input id="searchDecNo" type="text" placeholder="Nh·∫≠p DEC NO..."
         class="p-2 border border-gray-400 rounded w-full md:w-1/3" oninput="filterTableByDecNo()">
</div>
    <!-- B·∫£ng d·ªØ li·ªáu -->
    <div id="dataTable" class="overflow-x-auto mt-6 bg-white rounded shadow p-4"></div>
  </div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxa51dyD8V7RpKcc7gQu869x8RRV0j9XuM0LN6pxDXdA66A80PGSC3vwgo6PndVaWuLIw/exec'; // ‚ö†Ô∏è Thay b·∫±ng URL script c·ªßa b·∫°n
  let fullData = [];
let editingIndex = -1;
  
// Ghi d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß ƒë·ªÉ t√¨m ki·∫øm sau khi fetch
async function fetchData() {
  const res = await fetch(API_URL);
  fullData = await res.json();
  renderTable(fullData);
}

function filterTableByDecNo() {
  const keyword = document.getElementById('searchDecNo').value.trim().toLowerCase();
  if (!keyword) {
    renderTable(fullData);
    return;
  }
  const filtered = fullData.filter(row => {
    const val = (row['DEC NO'] || '').toString().toLowerCase();
    return val.includes(keyword);
  });
  renderTable(filtered);
}


async function fetchData() {
  const res = await fetch(API_URL);
  const data = await res.json();
  renderTable(data);
}

function renderTable(data) {
  const container = document.getElementById('dataTable');
  const table = document.createElement('table');
  table.className = 'min-w-full border border-gray-300';
  if (data.length === 0) return (container.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu.</p>');

  const headers = Object.keys(data[0]);
  table.innerHTML = `
    <thead>
      <tr>${headers.map(h => `<th class='border px-2 py-1 bg-gray-200'>${h}</th>`).join('')}<th>H√†nh ƒë·ªông</th></tr>
    </thead>
    <tbody>
      ${data.map((row, i) => `
        <tr>
          ${headers.map(h => `<td class='border px-2 py-1'>${row[h]}</td>`).join('')}
          <td class='border px-2 py-1'>
            <button onclick='editRow(${i})' class='text-blue-500 mr-2'>S·ª≠a</button>
            <button onclick='deleteRow(${i + 1})' class='text-red-500'>Xo√°</button>
          </td>
        </tr>
      `).join('')}
    </tbody>
  `;
  container.innerHTML = '';
  container.appendChild(table);
}

function editRow(index) {
  editingIndex = index;
  const row = document.querySelectorAll("#dataTable table tbody tr")[index];
  const cells = row.querySelectorAll("td");
  const headers = Array.from(document.querySelectorAll("#dataTable table thead th")).map(th => th.innerText);

  const form = document.getElementById("importForm");
  headers.forEach((header, i) => {
    if (header === "H√†nh ƒë·ªông") return;
    const input = form.querySelector(`[name="${header}"]`);
    if (input) input.value = cells[i].innerText;
  });

  const resultDiv = document.getElementById('addResult');
  resultDiv.innerHTML = `<p class="font-bold text-yellow-700">üõ† ƒêang ch·ªânh s·ª≠a d√≤ng ${index + 2}...</p>`;
  resultDiv.classList.remove('hidden');
  window.scrollTo({ top: 0, behavior: "smooth" });
}

async function deleteRow(index) {
  if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° d√≤ng n√†y?')) return;
  await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'delete', index })
  });

  const resultDiv = document.getElementById('addResult');
  resultDiv.innerHTML = `<p class="font-bold text-red-700">üóë ƒê√£ xo√° d√≤ng ${index} th√†nh c√¥ng.</p>`;
  resultDiv.classList.remove('hidden');

  fetchData();
}

function showTable() {
  document.getElementById('dataTable').classList.remove('hidden');
  document.getElementById('showTableBtn').classList.add('hidden');
}

const form = document.getElementById('importForm');
form.onsubmit = async e => {
  e.preventDefault();
  const formData = new FormData(form);
  const obj = {};
  formData.forEach((v, k) => { if (k !== 'pdfFile') obj[k] = v });

  const file = formData.get('pdfFile');
  let fileData = null;
  if (file && file.size > 0) {
    const b64 = await file.arrayBuffer().then(buf => btoa(String.fromCharCode(...new Uint8Array(buf))));
    fileData = { name: file.name, mimeType: file.type, data: b64 };
  }

  const resultDiv = document.getElementById('addResult');
  if (editingIndex > -1) {
    await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'update', index: editingIndex + 2, data: obj, file: fileData })
    });
    resultDiv.innerHTML = `<p class="font-bold text-blue-700">‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng d√≤ng ${editingIndex + 2}!</p>`;
    editingIndex = -1;
  } else {
    await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'add', data: obj, file: fileData })
    });
    let infoHtml = `<p class="font-bold mb-2">‚úÖ Th√™m th√†nh c√¥ng!</p><ul class="list-disc list-inside space-y-1">`;
    Object.keys(obj).forEach(key => infoHtml += `<li><strong>${key}:</strong> ${obj[key]}</li>`);
    infoHtml += `</ul>`;
    resultDiv.innerHTML = infoHtml;

    // ·∫®n b·∫£ng v√† hi·ªán n√∫t "Xem t·∫•t c·∫£"
    document.getElementById('dataTable').classList.add('hidden');
    document.getElementById('showTableBtn').classList.remove('hidden');
  }

  resultDiv.classList.remove('hidden');
  form.reset();
  fetchData();
};

async function exportCsv() {
  const res = await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'exportCsv' })
  });
  const url = await res.text();
  if (url.startsWith("http")) window.open(url, '_blank');
  else alert("Xu·∫•t th·∫•t b·∫°i: " + url);
}

async function exportAtcEmptyCsv() {
  const res = await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'exportAtcEmptyCsv' })
  });
  const url = await res.text();
  if (url.startsWith("http")) window.open(url, '_blank');
  else alert("Xu·∫•t th·∫•t b·∫°i: " + url);
}

fetchData();
</script>
</body>
</html>
