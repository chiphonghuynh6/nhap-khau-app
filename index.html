<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý nhập khẩu</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-screen-xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">Quản lý nhập khẩu</h1>

<form id="importForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-white p-4 rounded shadow">
  <!-- Thông tin chung -->
  <fieldset class="border p-4 space-y-2">
    <legend class="font-semibold">Thông tin chung</legend>

    <div>
      <label class="block font-medium">GET DOCS</label>
      <input type="date" name="GET DOCS" class="w-full p-2 border border-black rounded"/>
    </div>

    <div>
      <label class="block font-medium">DEC NO</label>
      <input type="text" name="DEC NO" class="w-full p-2 border border-black rounded"/>
    </div>

    <div>
      <label class="block font-medium">FACT NO</label>
      <select name="FACT NO" class="w-full p-2 border border-black rounded">
        <option></option>
        <option>18A</option>
        <option>B0SZ</option>
        <option>B0M1</option>
        <option>B0M2</option>
      </select>
    </div>

    <div>
      <label class="block font-medium">LOẠI HÌNH</label>
      <select name="LOẠI HÌNH" class="w-full p-2 border border-black rounded">
        <option></option>
        <option>A12</option>
        <option>E21</option>
        <option>H11</option>
      </select>
    </div>

    <div>
      <label class="block font-medium">FWD</label>
      <input type="text" name="FWD" class="w-full p-2 border border-black rounded"/>
    </div>

    <div>
      <label class="block font-medium">SUPPLIER</label>
      <input type="text" name="SUPPLIER" class="w-full p-2 border border-black rounded"/>
    </div>

    <div>
      <label class="block font-medium">TYPE</label>
      <select name="TYPE" class="w-full p-2 border border-black rounded">
        <option></option>
        <option>CONT</option>
        <option>CFS</option>
        <option>NGOAI QUAN</option>
        <option>BY TRUCK</option>
        <option>DHL</option>
        <option>AIR</option>
      </select>
    </div>

    <div>
      <label class="block font-medium">ORIGIN</label>
      <input type="text" name="ORIGIN" class="w-full p-2 border border-black rounded"/>
    </div>
  </fieldset>

  <!-- Thông tin vận đơn -->
  <fieldset class="border p-4 space-y-2">
    <legend class="font-semibold">Thông tin vận đơn</legend>

    <div>
      <label class="block font-medium">BILL NO</label>
      <input type="text" name="BILL NO" class="w-full p-2 border border-black rounded"/>
    </div>

    <div>
      <label class="block font-medium">BILL DATE</label>
      <input type="date" name="BILL DATE" class="w-full p-2 border border-black rounded"/>
    </div>

    <div>
      <label class="block font-medium">PACKAGES</label>
      <input type="number" name="PACKAGES" class="w-full p-2 border border-black rounded"/>
    </div>

    <div>
      <label class="block font-medium">GW</label>
      <input type="number" name="GW" class="w-full p-2 border border-black rounded"/>
    </div>

    <div>
      <label class="block font-medium">CBM</label>
      <input type="number" name="CBM" class="w-full p-2 border border-black rounded"/>
    </div>

    <div>
      <label class="block font-medium">CTN NO</label>
      <input type="text" name="CTN NO" class="w-full p-2 border border-black rounded"/>
    </div>

    <div>
      <label class="block font-medium">ETA DATE</label>
      <input type="date" name="ETA DATE" class="w-full p-2 border border-black rounded"/>
    </div>

    <div>
      <label class="block font-medium">ATC</label>
      <input type="date" name="ATC" class="w-full p-2 border border-black rounded"/>
    </div>
  </fieldset>

  <!-- Thông tin hóa đơn -->
  <fieldset class="border p-4 space-y-2">
    <legend class="font-semibold">Thông tin hóa đơn</legend>

    <div>
      <label class="block font-medium">INV NO</label>
      <input type="text" name="INV NO" class="w-full p-2 border border-black rounded"/>
    </div>

    <div>
      <label class="block font-medium">INV DATE</label>
      <input type="date" name="INV DATE" class="w-full p-2 border border-black rounded"/>
    </div>

    <div>
      <label class="block font-medium">AMOUNT</label>
      <input type="number" name="AMOUNT" class="w-full p-2 border border-black rounded"/>
    </div>

    <div>
      <label class="block font-medium">TERM</label>
      <select name="TERM" class="w-full p-2 border border-black rounded">
        <option></option>
        <option>CIF</option>
        <option>FOB</option>
        <option>C&F</option>
        <option>FCA</option>
        <option>EXW</option>
        <option>CPT</option>
        <option>DAT</option>
        <option>DAP</option>
        <option>CIP</option>
      </select>
    </div>

    <div>
      <label class="block font-medium">File PDF</label>
      <input type="file" id="pdfFile" class="w-full p-2 border border-black rounded"/>
    </div>
  </fieldset>

  <!-- Nút Thêm -->
  <div class="md:col-span-3">
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded w-full md:w-auto">
      Thêm lô mới
    </button>
  </div>
</form>
<div id="dataTable" class="overflow-x-auto mt-6 bg-white rounded shadow p-4"></div>
  </div>
<!-- Hiển thị kết quả sau khi thêm -->
<div id="addResult" class="mt-4 hidden bg-green-50 border border-green-400 p-4 rounded text-green-700"></div>


<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwAEpr2QboZr-0FpLUHyJsA-rpKvnsO0Ks6-na2qv96SxwtJQU1fcn327HMd70XymjMaw/exec';
let editingIndex = -1;

async function fetchData() {
  const res = await fetch(API_URL);
  const data = await res.json();
  renderTable(data);
}

function renderTable(data) {
  const container = document.getElementById('dataTable');
  const table = document.createElement('table');
  table.className = 'min-w-full border border-gray-300';
  if (data.length === 0) return (container.innerHTML = '<p>Không có dữ liệu.</p>');

  const headers = Object.keys(data[0]);
  table.innerHTML = `
    <thead>
      <tr>${headers.map(h => `<th class='border px-2 py-1 bg-gray-200'>${h}</th>`).join('')}<th>Hành động</th></tr>
    </thead>
    <tbody>
      ${data.map((row, i) => `
        <tr>
          ${headers.map(h => `<td class='border px-2 py-1'>${row[h]}</td>`).join('')}
          <td class='border px-2 py-1'>
            <button onclick='editRow(${i})' class='text-blue-500 mr-2'>Sửa</button>
            <button onclick='deleteRow(${i + 1})' class='text-red-500'>Xoá</button>
          </td>
        </tr>
      `).join('')}
    </tbody>
  `;
  container.innerHTML = '';
  container.appendChild(table);
}

async function deleteRow(index) {
  if (!confirm('Xác nhận xoá?')) return;
  await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'delete', index })
  });
  fetchData();
}

function editRow(index) {
  editingIndex = index;
  const row = document.querySelectorAll("#dataTable table tbody tr")[index];
  const cells = row.querySelectorAll("td");
  const headers = Array.from(document.querySelectorAll("#dataTable table thead th")).map(th => th.innerText);

  const form = document.getElementById("importForm");
  headers.forEach((header, i) => {
    if (header === "Hành động") return;
    const input = form.querySelector(`[name="${header}"]`);
    if (input) input.value = cells[i].innerText;
  });

  window.scrollTo({ top: 0, behavior: "smooth" });
}

async function exportAtcEmpty() {
  const res = await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'exportAtcEmpty' })
  });
  const url = await res.text();
  window.open(url, '_blank');
}

const form = document.getElementById('importForm');
form.onsubmit = async e => {
  e.preventDefault();
  const formData = new FormData(form);
  const obj = {};
  formData.forEach((v, k) => { if (k !== 'pdfFile') obj[k] = v });

  const file = formData.get('pdfFile');
  let fileData = null;
  if (file && file.size > 0) {
    const b64 = await file.arrayBuffer().then(buf => btoa(String.fromCharCode(...new Uint8Array(buf))));
    fileData = {
      name: file.name,
      mimeType: file.type,
      data: b64
    };
  }

  if (editingIndex > -1) {
    await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'update', index: editingIndex + 2, data: obj, file: fileData })
    });
    editingIndex = -1;
  } else {
    await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'add', data: obj, file: fileData })
    });
  }

  form.reset();

// ✅ Hiển thị thông báo và thông tin vừa nhập
const resultDiv = document.getElementById('addResult');
let infoHtml = `<p class="font-bold mb-2">✅ Thêm thành công!</p>`;
infoHtml += `<ul class="list-disc list-inside space-y-1">`;
Object.keys(obj).forEach(key => {
  infoHtml += `<li><strong>${key}:</strong> ${obj[key]}</li>`;
});
infoHtml += `</ul>`;
resultDiv.innerHTML = infoHtml;
resultDiv.classList.remove('hidden');

// ✅ Làm mới bảng
fetchData();

};

fetchData();
</script>
</body>
</html>
