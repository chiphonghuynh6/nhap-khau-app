<!DOCTYPE html>

<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω nh·∫≠p kh·∫©u</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
  .editing-row {
    background-color: #FEF9C3; /* m√†u v√†ng nh·∫°t */
  }
</style>
</head>
<body class="bg-gray-50 p-4">
  <div class="max-w-6xl mx-auto bg-white p-4 rounded-lg shadow">
    <h1 class="text-xl font-semibold mb-4">Th√¥ng tin h√†ng nh·∫≠p</h1>

      <!-- N√∫t Th√™m -->
<div class="mb-4">
  <button id="addNewBtn" type="button" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
    ‚ûï Th√™m m·ªõi
  </button>
</div>
<!-- Form nh·∫≠p li·ªáu -->
<form id="importForm" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">

  <!-- Th√¥ng tin chung -->

  <fieldset class="border p-4 space-y-2">
    <legend class="font-semibold">Th√¥ng tin chung</legend>

<div>
  <label class="block font-medium mb-1">GET DOCS</label>
  <input type="date" name="GET DOCS" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">DEC NO</label>
  <input type="text" name="DEC NO" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">FACT NO</label>
  <select name="FACT NO" class="w-full border rounded px-2 py-1">
    <option></option>
    <option>18A</option>
    <option>B0SZ</option>
    <option>B0M1</option>
    <option>B0M2</option>
  </select>
</div>

<div>
  <label class="block font-medium mb-1">LO·∫†I H√åNH</label>
  <select name="LO·∫†I H√åNH" class="w-full border rounded px-2 py-1">
    <option></option>
    <option>A12</option>
    <option>E21</option>
    <option>H11</option>
  </select>
</div>

<div>
  <label class="block font-medium mb-1">FWD</label>
  <input type="text" name="FWD" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">SUPPLIER</label>
  <input type="text" name="SUPPLIER" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">TYPE</label>
  <select name="TYPE" class="w-full border rounded px-2 py-1">
    <option></option>
    <option>CONT</option>
    <option>CFS</option>
    <option>NGOAI QUAN</option>
    <option>BY TRUCK</option>
    <option>DHL</option>
    <option>AIR</option>
  </select>
</div>

<div>
  <label class="block font-medium mb-1">ORIGIN</label>
  <input type="text" name="ORIGIN" class="w-full border rounded px-2 py-1"/>
</div>

  </fieldset>

  <!-- Th√¥ng tin v·∫≠n ƒë∆°n -->

  <fieldset class="border p-4 space-y-2">
    <legend class="font-semibold">Th√¥ng tin v·∫≠n ƒë∆°n</legend>

<div>
  <label class="block font-medium mb-1">BILL NO</label>
  <input type="text" name="BILL NO" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">BILL DATE</label>
  <input type="date" name="BILL DATE" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">PACKAGES</label>
  <input type="number" name="PACKAGES" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">GW</label>
  <input type="number" name="GW" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">CBM</label>
  <input type="number" name="CBM" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">CTN NO</label>
  <input type="text" name="CTN NO" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">ETA DATE</label>
  <input type="date" name="ETA DATE" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">ATC</label>
  <input type="date" name="ATC" class="w-full border rounded px-2 py-1"/>
</div>

  </fieldset>

  <!-- Th√¥ng tin h√≥a ƒë∆°n -->

  <fieldset class="border p-4 space-y-2">
    <legend class="font-semibold">Th√¥ng tin h√≥a ƒë∆°n</legend>

<div>
  <label class="block font-medium mb-1">INV NO</label>
  <input type="text" name="INV NO" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">INV DATE</label>
  <input type="date" name="INV DATE" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">AMOUNT</label>
  <input type="text" name="AMOUNT" class="w-full border rounded px-2 py-1"/>
</div>

<div>
  <label class="block font-medium mb-1">TERM</label>
  <select name="TERM" class="w-full border rounded px-2 py-1">
    <option></option>
    <option>CIF</option>
    <option>FOB</option>
    <option>C&F</option>
    <option>FCA</option>
    <option>EXW</option>
    <option>CPT</option>
    <option>DAT</option>
    <option>DAP</option>
    <option>CIP</option>
  </select>
</div>

<div>
  <label class="block font-medium">File PDF</label>
  <input type="file" id="pdfFile" class="w-full border rounded px-2 py-1"/>
</div>

  </fieldset>


  <div class="md:col-span-3">
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded w-full md:w-auto">
      L∆∞u
    </button>
   </div>
</form>

<!-- Th√¥ng b√°o k·∫øt qu·∫£ -->
<div id="addResult" class="mt-4 hidden bg-green-50 border border-green-400 p-4 rounded text-green-700"></div>

<!-- N√∫t xem b·∫£ng v√† export -->
<div class="mt-2 hidden" id="showTableBtn">
  <button onclick="showTable()" class="text-blue-600 underline hover:text-blue-800">üëâ Xem to√†n b·ªô danh s√°ch l√¥ h√†ng</button>
</div>

<div class="mt-4 flex flex-wrap gap-2">
  <button onclick="exportCsv()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">üì§ Xu·∫•t to√†n b·ªô CSV</button>
  <button onclick="exportAtcEmptyCsv()" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">üì§ Xu·∫•t ATC tr·ªëng CSV</button>
</div>
    
  <!-- T√¨m ki·∫øm -->
    <div class="mt-4 flex items-center gap-2">
      <label for="searchDecNo" class="font-medium">T√¨m theo DEC NO:</label>
      <input id="searchDecNo" type="text" placeholder="Nh·∫≠p DEC NO..." class="p-2 border border-gray-400 rounded w-full md:w-1/3" oninput="filterTableByDecNo()">
    </div>
    
    <!-- B·∫£ng d·ªØ li·ªáu -->
    <div id="dataTable" class="overflow-x-auto mt-6 bg-white rounded shadow p-4"></div>
  </div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwliHSkkasAoJtcsvc_VhcywAPMGlStKSW-rNWQYubglNSpbh5E43q1PK3kV80_W-5nHg/exec';
let editingIndex = -1;
let fullData = [];

async function fetchData() {
  const res = await fetch(API_URL);
  fullData = await res.json();
  renderTable(fullData);
  document.getElementById('dataTable').classList.remove('hidden');
  document.getElementById('showTableBtn').classList.add('hidden');
}

function renderTable(data) {
  const container = document.getElementById('dataTable');
  if (!data || data.length === 0) {
    container.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
    return;
  }

  const headers = Object.keys(data[0]);
  const table = document.createElement('table');
  table.className = 'min-w-full border border-gray-300 text-sm';

  const thead = `<thead><tr>${headers.map(h => `<th class='border px-2 py-1 bg-gray-200 sticky top-0 z-10'>${h}</th>`).join('')}<th class='border px-2 py-1 bg-gray-200 sticky top-0 z-10'>H√†nh ƒë·ªông</th></tr></thead>`;
  const tbody = data.map((row, i) => {
    const cells = headers.map(h => {
      let value = row[h];
      if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}T/.test(value.trim())) {
        const d = new Date(value);
        if (!isNaN(d.getTime())) value = d.toLocaleDateString('vi-VN');
      }
      return `<td class='border px-2 py-1'>${value}</td>`;
    }).join('');
    const actions = `<td class='border px-2 py-1 text-center'>
      <button onclick="editRow(${i})" class="text-blue-600 hover:underline">S·ª≠a</button> |
      <button onclick="deleteRow(${i + 2})" class="text-red-600 hover:underline">Xo√°</button>
    </td>`;
    return `<tr>${cells}${actions}</tr>`;
  }).join('');

  table.innerHTML = `${thead}<tbody>${tbody}</tbody>`;
  container.innerHTML = '';
  container.appendChild(table);
}

let originalRowData = {};

  


function editRow(index) {
  editingIndex = index;
  const row = document.querySelectorAll("#dataTable table tbody tr")[index];
  const cells = row.querySelectorAll("td");
  const headers = Array.from(document.querySelectorAll("#dataTable table thead th")).map(th => th.innerText);
  const form = document.getElementById("importForm");

  headers.forEach((header, i) => {
    if (header === "H√†nh ƒë·ªông") return;

    const input = form.querySelector(`[name="${header}"]`);
    if (input) {
      let value = cells[i].innerText;

      // Ki·ªÉm tra n·∫øu l√† input type="date" th√¨ chuy·ªÉn ƒë·ªãnh d·∫°ng v·ªÅ yyyy-mm-dd
     if (input.type === "date" && value) {
  const parts = value.split(/[\/\-]/);
  if (parts.length === 3) {
    let day, month, year;

    if (value.includes('/')) {
      [day, month, year] = parts;
    } else {
      // Tr∆∞·ªùng h·ª£p ng√†y ƒë√£ l√† yyyy-mm-dd ho·∫∑c yyyy/mm/dd
      [year, month, day] = parts;
    }

    // Ki·ªÉm tra h·ª£p l·ªá
    if (year.length === 4 && month.length <= 2 && day.length <= 2) {
      value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    }
  }
}

      input.value = value;
    }
  });

  const resultDiv = document.getElementById('addResult');
  resultDiv.innerHTML = `<p class="font-bold text-yellow-700">üõ† ƒêang ch·ªânh s·ª≠a d√≤ng ${index + 2}...</p>`;
  resultDiv.classList.remove('hidden');
  window.scrollTo({ top: 0, behavior: "smooth" });
}

  function handleUpdate() {
  const form = document.getElementById("importForm");
  const inputs = form.querySelectorAll("input, select, textarea"); // t·∫•t c·∫£ tr∆∞·ªùng d·ªØ li·ªáu

  const updatedData = {};
  inputs.forEach(input => {
    const key = input.name;
    const value = input.value.trim();
    // N·∫øu input tr·ªëng, d√πng l·∫°i d·ªØ li·ªáu g·ªëc
    updatedData[key] = value || originalRowData[key] || "";
  });
    if (currentEditingRow) {
    currentEditingRow.classList.remove("editing-row");
    currentEditingRow = null;
  }

  // G·ª≠i d·ªØ li·ªáu n√†y l√™n API, v√≠ d·ª•:
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "update",
      rowIndex: editingIndex + 2,
      data: updatedData
    }),
    headers: {
      "Content-Type": "application/json"
    }
  }).then(response => {
    // X·ª≠ l√Ω sau c·∫≠p nh·∫≠t...
  });
}


async function deleteRow(index) {
  if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° d√≤ng n√†y?')) return;

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'delete',
        rowIndex: index
      })
    });
    const result = await res.json();

    document.getElementById('addResult').classList.remove('hidden');
    document.getElementById('addResult').innerText = result.message || 'üóë Xo√° th√†nh c√¥ng';
    fetchData(); // Refresh table
  } catch (error) {
    alert('C√≥ l·ªói khi xo√° d·ªØ li·ªáu!');
    console.error(error);
  }
}


function showTable() {
  fetchData();
}

const form = document.getElementById('importForm');
form.onsubmit = async e => {
  e.preventDefault();
  const formData = new FormData(form);
  const obj = {};
  formData.forEach((v, k) => { if (k !== 'pdfFile') obj[k] = v });

  const resultDiv = document.getElementById('addResult');
  if (editingIndex > -1) {
    await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'update', index: editingIndex + 2, data: obj })
    });
    resultDiv.innerHTML = `<p class="font-bold text-blue-700">‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng d√≤ng ${editingIndex + 2}!</p>`;
    editingIndex = -1;
  } else {
    await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'add', data: obj })
    });
    resultDiv.innerHTML = `<p class="font-bold text-green-700">‚úÖ Th√™m d√≤ng m·ªõi th√†nh c√¥ng!</p>`;
  }
  resultDiv.classList.remove('hidden');
  form.reset();
  fetchData();
};

function filterTableByDecNo() {
  const keyword = document.getElementById('searchDecNo').value.trim().toLowerCase();
  const filtered = fullData.filter(row => (row["DEC NO"] || '').toLowerCase().includes(keyword));
  renderTable(filtered);
}

// T·ª± ƒë·ªông fetch khi t·∫£i trang
window.onload = () => {
  fetchData();
};

function exportCsv() {
  let csv = '';
  const headers = Object.keys(fullData[0]);
  csv += headers.join(',') + '\n';
  fullData.forEach(row => {
    csv += headers.map(h => `"${row[h] || ''}"`).join(',') + '\n';
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'danhsach_lohang.csv';
  link.click();
}

function exportAtcEmptyCsv() {
  const filtered = fullData.filter(row => !row["ATC"]);
  let csv = '';
  const headers = Object.keys(filtered[0] || {});
  csv += headers.join(',') + '\n';
  filtered.forEach(row => {
    csv += headers.map(h => `"${row[h] || ''}"`).join(',') + '\n';
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'lohang_chua_atc.csv';
  link.click();
}

  // üÜï Kho√°/m·ªü form
function setFormDisabled(disabled) {
  const form = document.getElementById('importForm');
  const elements = form.querySelectorAll('input, select, textarea, button[type="submit"]');
  elements.forEach(el => {
    if (el.type !== 'button') el.disabled = disabled;
  });
}

// üÜï N√∫t "Th√™m m·ªõi"
document.getElementById('addNewBtn').addEventListener('click', () => {
  editingIndex = -1;
  document.getElementById('importForm').reset();
  setFormDisabled(false);
  document.getElementById('addResult').classList.add('hidden');
  window.scrollTo({ top: 0, behavior: "smooth" });
});

// üÜï S·ª≠a l·∫°i s·ª± ki·ªán submit form
form.onsubmit = async e => {
  e.preventDefault();
  const formData = new FormData(form);
  const obj = {};
  formData.forEach((v, k) => { if (k !== 'pdfFile') obj[k] = v });

  const resultDiv = document.getElementById('addResult');
  if (editingIndex > -1) {
    await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'update', index: editingIndex + 2, data: obj })
    });
    resultDiv.innerHTML = `<p class="font-bold text-blue-700">‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng d√≤ng ${editingIndex + 2}!</p>`;
    editingIndex = -1;
  } else {
    await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'add', data: obj })
    });
    resultDiv.innerHTML = `<p class="font-bold text-green-700">‚úÖ Th√™m d√≤ng m·ªõi th√†nh c√¥ng!</p>`;
  }

  resultDiv.classList.remove('hidden');
  form.reset();
  setFormDisabled(true); // üÜï kh√≥a l·∫°i form
  fetchData();
};

// üÜï Kh√≥a form khi v·ª´a v√†o trang
window.onload = () => {
  fetchData();
  setFormDisabled(true);
};

</script>
</body>
</html>
