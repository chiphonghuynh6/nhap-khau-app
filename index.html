<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω nh·∫≠p kh·∫©u</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .editing-row {
      background-color: #FEF9C3; /* m√†u v√†ng nh·∫°t */
    }
  </style>
</head>
<body class="bg-gray-50 p-4">
  <div class="max-w-6xl mx-auto bg-white p-4 rounded-lg shadow">
    <h1 class="text-xl font-semibold mb-4">Th√¥ng tin h√†ng nh·∫≠p</h1>

    <!-- N√∫t Th√™m -->
    <div class="mb-4">
      <button id="addNewBtn" type="button" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
        ‚ûï Th√™m m·ªõi
      </button>
    </div>
    <!-- Form nh·∫≠p li·ªáu -->
    <form id="importForm" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">

      <!-- Th√¥ng tin chung -->
      <fieldset class="border p-4 space-y-2">
        <legend class="font-semibold">Th√¥ng tin chung</legend>

        <div>
          <label class="block font-medium mb-1">GET_DOCS</label>
          <input type="date" name="GET_DOCS" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">DEC_NO</label>
          <input type="text" name="DEC_NO" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">FACT_NO</label>
          <select name="FACT_NO" class="w-full border rounded px-2 py-1">
            <option></option>
            <option>18A</option>
            <option>B0SZ</option>
            <option>B0M1</option>
            <option>B0M2</option>
          </select>
        </div>
        <div>
          <label class="block font-medium mb-1">LOAI_HINH</label>
          <select name="LOAI_HINH" class="w-full border rounded px-2 py-1">
            <option></option>
            <option>A12</option>
            <option>E21</option>
            <option>H11</option>
          </select>
        </div>
        <div>
          <label class="block font-medium mb-1">FWD</label>
          <input type="text" name="FWD" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">SUPPLIER</label>
          <input type="text" name="SUPPLIER" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">TYPE</label>
          <select name="TYPE" class="w-full border rounded px-2 py-1">
            <option></option>
            <option>CONT</option>
            <option>CFS</option>
            <option>NGOAI_QUAN</option>
            <option>BY_TRUCK</option>
            <option>DHL</option>
            <option>AIR</option>
          </select>
        </div>
        <div>
          <label class="block font-medium mb-1">ORIGIN</label>
          <input type="text" name="ORIGIN" class="w-full border rounded px-2 py-1"/>
        </div>
      </fieldset>

      <!-- Th√¥ng tin v·∫≠n ƒë∆°n -->
      <fieldset class="border p-4 space-y-2">
        <legend class="font-semibold">Th√¥ng tin v·∫≠n ƒë∆°n</legend>

        <div>
          <label class="block font-medium mb-1">BILL_NO</label>
          <input type="text" name="BILL_NO" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">BILL_DATE</label>
          <input type="date" name="BILL_DATE" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">PACKAGES</label>
          <input type="number" name="PACKAGES" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">GW</label>
          <input type="number" name="GW" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">CBM</label>
          <input type="number" name="CBM" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">CTN_NO</label>
          <input type="text" name="CTN_NO" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">ETA_DATE</label>
          <input type="date" name="ETA_DATE" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">ATC</label>
          <input type="date" name="ATC" class="w-full border rounded px-2 py-1"/>
        </div>
      </fieldset>

      <!-- Th√¥ng tin h√≥a ƒë∆°n -->
      <fieldset class="border p-4 space-y-2">
        <legend class="font-semibold">Th√¥ng tin h√≥a ƒë∆°n</legend>

        <div>
          <label class="block font-medium mb-1">INV_NO</label>
          <input type="text" name="INV_NO" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">INV_DATE</label>
          <input type="date" name="INV_DATE" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">AMOUNT</label>
          <input type="text" name="AMOUNT" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">TERM</label>
          <select name="TERM" class="w-full border rounded px-2 py-1">
            <option></option>
            <option>CIF</option>
            <option>FOB</option>
            <option>C&F</option>
            <option>FCA</option>
            <option>EXW</option>
            <option>CPT</option>
            <option>DAT</option>
            <option>DAP</option>
            <option>CIP</option>
          </select>
        </div>
        <div>
          <label class="block font-medium">File PDF</label>
          <input type="file" id="pdfFile" name="pdfFile" class="w-full border rounded px-2 py-1"/>
        </div>
      </fieldset>

      <div class="md:col-span-3">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded w-full md:w-auto">
          L∆∞u
        </button>
      </div>
    </form>

    <!-- Th√¥ng b√°o k·∫øt qu·∫£ -->
    <div id="addResult" class="mt-4 hidden bg-green-50 border border-green-400 p-4 rounded text-green-700"></div>

    <!-- N√∫t xem b·∫£ng v√† export -->
    <div class="mt-2" id="showTableBtn">
      <button onclick="showTable()" class="text-blue-600 underline hover:text-blue-800">üëâ Xem to√†n b·ªô danh s√°ch l√¥ h√†ng</button>
    </div>

    <div class="mt-4 flex flex-wrap gap-2">
      <button onclick="exportCsv()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">üì§ Xu·∫•t to√†n b·ªô CSV</button>
      <button onclick="exportAtcEmptyCsv()" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">üì§ Xu·∫•t ATC tr·ªëng CSV</button>
    </div>
    
    <!-- T√¨m ki·∫øm -->
    <div class="mt-4 flex items-center gap-2">
      <label for="searchDecNo" class="font-medium">T√¨m theo DEC_NO:</label>
      <input id="searchDecNo" type="text" placeholder="Nh·∫≠p DEC_NO..." class="p-2 border border-gray-400 rounded w-full md:w-1/3" oninput="filterTableByDecNo()">
    </div>
    
    <!-- B·∫£ng d·ªØ li·ªáu -->
    <div id="dataTable" class="overflow-x-auto mt-6 bg-white rounded shadow p-4"></div>
  </div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbyXlFG5SzMu9-4gfwviWCueGSmBbbA2ab8ZQNNEBkA6yJlOODvsgRgk8PKgLUtIbKqe/exec';
let editingIndex = -1;
let fullData = [];

// Helper: Chuy·ªÉn t√™n tr∆∞·ªùng t·ª´ tr∆∞·ªõc (c√≥ d·∫•u c√°ch) sang snake_case
function mapFieldName(field) {
  // N·∫øu b·∫°n chuy·ªÉn t√™n tr∆∞·ªùng ·ªü backend, h√£y ƒë·ªìng b·ªô t√™n tr∆∞·ªùng ·ªü ƒë√¢y v·ªõi backend!
  return field.replace(/ /g, "_");
}

async function fetchData() {
  try {
    const res = await fetch(API_URL);
    fullData = await res.json();
    renderTable(fullData);
    document.getElementById('dataTable').classList.remove('hidden');
  } catch (err) {
    console.error("‚ùå L·ªói khi fetch d·ªØ li·ªáu:", err);
  }
}

function renderTable(data) {
  const container = document.getElementById('dataTable');
  if (!data || data.length === 0) {
    container.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
    return;
  }

  const headers = Object.keys(data[0]);
  const table = document.createElement('table');
  table.className = 'min-w-full border border-gray-300 text-sm';

  const thead = `<thead><tr>${headers.map(h => `<th class='border px-2 py-1 bg-gray-200 sticky top-0 z-10'>${h}</th>`).join('')}<th class='border px-2 py-1 bg-gray-200 sticky top-0 z-10'>H√†nh ƒë·ªông</th></tr></thead>`;
  const tbody = data.map((row, i) => {
    const cells = headers.map(h => {
      let value = row[h];
      if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}T/.test(value.trim())) {
        const d = new Date(value);
        if (!isNaN(d.getTime())) value = d.toLocaleDateString('vi-VN');
      }
      return `<td class='border px-2 py-1'>${value || ''}</td>`;
    }).join('');
    const actions = `<td class='border px-2 py-1 text-center'>
      <button onclick="editRow(${i})" class="text-blue-600 hover:underline">S·ª≠a</button> |
      <button onclick="deleteRow(${i + 2})" class="text-red-600 hover:underline">Xo√°</button>
    </td>`;
    return `<tr ${editingIndex === i ? 'class="editing-row"' : ''}>${cells}${actions}</tr>`;
  }).join('');

  table.innerHTML = `${thead}<tbody>${tbody}</tbody>`;
  container.innerHTML = '';
  container.appendChild(table);
}

function editRow(index) {
  editingIndex = index;
  const rowData = fullData[index];
  const form = document.getElementById("importForm");

  // L·∫•y to√†n b·ªô input/select trong form
  form.querySelectorAll('input[name], select[name], textarea[name]').forEach(input => {
    // T√¨m key trong rowData: th·ª≠ theo name, ho·∫∑c thay _ th√†nh d·∫•u c√°ch
    let field = input.name;
    let value = rowData[field];
    if (typeof value === "undefined") {
      // Th·ª≠ thay _ th√†nh d·∫•u c√°ch ƒë·ªÉ map ng∆∞·ª£c
      const altField = field.replace(/_/g, " ");
      value = rowData[altField];
    }
    if (typeof value === "undefined") value = "";
    // N·∫øu l√† input date, chu·∫©n h√≥a yyyy-mm-dd
    if (input.type === "date" && value) {
      let dateValue = value;
      if (/^\d{4}-\d{2}-\d{2}/.test(value)) {
        dateValue = value.slice(0, 10);
      } else if (/^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
        const [day, month, year] = value.split("/");
        dateValue = `${year}-${month.padStart(2, "0")}-${day.padStart(2, "0")}`;
      }
      input.value = dateValue;
    } else {
      input.value = value;
    }
  });

  const resultDiv = document.getElementById('addResult');
  resultDiv.innerHTML = `<p class="font-bold text-yellow-700">üõ† ƒêang ch·ªânh s·ª≠a d√≤ng ${index + 2}...</p>`;
  resultDiv.classList.remove('hidden');
  window.scrollTo({ top: 0, behavior: "smooth" });

  setFormDisabled(false);
}



async function deleteRow(index) {
  if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° d√≤ng n√†y?')) return;

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'delete',
        index: index // Th·ªëng nh·∫•t d√πng 'index'
      })
    });
    const result = await res.json();

    document.getElementById('addResult').classList.remove('hidden');
    document.getElementById('addResult').innerText = result.message || 'üóë Xo√° th√†nh c√¥ng';
    fetchData(); // Refresh table
    setFormDisabled(true);
  } catch (error) {
    alert('C√≥ l·ªói khi xo√° d·ªØ li·ªáu!');
    console.error(error);
  }
}

function showTable() {
  fetchData();
}

function filterTableByDecNo() {
  const keyword = document.getElementById('searchDecNo').value.trim().toLowerCase();
  const filtered = fullData.filter(row => ((row["DEC_NO"] || '') + '').toLowerCase().includes(keyword));
  renderTable(filtered);
}

// T·ª± ƒë·ªông fetch khi t·∫£i trang v√† kho√° form
window.onload = () => {
  fetchData();
  setFormDisabled(true);
};

function setFormDisabled(disabled) {
  const form = document.getElementById('importForm');
  const elements = form.querySelectorAll('input, select, textarea, button[type="submit"]');
  elements.forEach(el => {
    if (el.type !== 'button') el.disabled = disabled;
  });
}

// N√∫t "Th√™m m·ªõi"
document.getElementById('addNewBtn').addEventListener('click', () => {
  editingIndex = -1;
  document.getElementById('importForm').reset();
  setFormDisabled(false);
  document.getElementById('addResult').classList.add('hidden');
  window.scrollTo({ top: 0, behavior: "smooth" });
});

// S·ª± ki·ªán submit form (th√™m m·ªõi & c·∫≠p nh·∫≠t)
const form = document.getElementById('importForm');
form.onsubmit = async e => {
  e.preventDefault();
  const formData = new FormData(form); // FormData s·∫Ω l·∫•y c·∫£ file PDF n·∫øu c√≥

  // N·∫øu ƒëang s·ª≠a th√¨ th√™m action, index v√†o formData
  if (editingIndex > -1) {
    formData.append('action', 'update');
    formData.append('index', editingIndex + 2);
  } else {
    formData.append('action', 'add');
  }
  // G·ª≠i formData, kh√¥ng c·∫ßn chuy·ªÉn sang JSON, gi·ªØ nguy√™n d·∫°ng multipart
  const resultDiv = document.getElementById('addResult');
  await fetch(API_URL, {
    method: 'POST',
    body: formData
    // KH√îNG set headers Content-Type, ƒë·ªÉ fetch t·ª± ƒë·ªông set multipart!
  });
  resultDiv.innerHTML = editingIndex > -1
    ? `<p class="font-bold text-blue-700">‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng d√≤ng ${editingIndex + 2}!</p>`
    : `<p class="font-bold text-green-700">‚úÖ Th√™m d√≤ng m·ªõi th√†nh c√¥ng!</p>`;
  editingIndex = -1;
  resultDiv.classList.remove('hidden');
  form.reset();
  setFormDisabled(true);
  fetchData();
};

// Export CSV to√†n b·ªô
async function exportCsv() {
  const res = await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'exportCsv' })
  });
  const result = await res.json();
  if (result.url) window.open(result.url, '_blank');
}

// Export CSV ch·ªâ nh·ªØng d√≤ng ATC tr·ªëng
async function exportAtcEmptyCsv() {
  const res = await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'exportAtcEmptyCsv' })
  });
  const result = await res.json();
  if (result.url) window.open(result.url, '_blank');
}

// Note: X·ª≠ l√Ω upload file PDF ch∆∞a l√†m! N·∫øu mu·ªën upload file b·∫°n c·∫ßn code th√™m ·ªü ƒë√¢y.

</script>
</body>
</html>
