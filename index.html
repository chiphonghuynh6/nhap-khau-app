<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω nh·∫≠p kh·∫©u</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .editing-row {
      background-color: #FEF9C3; /* m√†u v√†ng nh·∫°t */
    }
  </style>
</head>
<body class="bg-gray-50 p-4">
  <div class="max-w-6xl mx-auto bg-white p-4 rounded-lg shadow">
    <h1 class="text-xl font-semibold mb-4">Th√¥ng tin h√†ng nh·∫≠p</h1>

    <!-- N√∫t Th√™m -->
    <div class="mb-4">
      <button id="addNewBtn" type="button" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
        ‚ûï Th√™m m·ªõi
      </button>
    </div>
    <!-- Form nh·∫≠p li·ªáu -->
    <form id="importForm" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">

      <!-- Th√¥ng tin chung -->
      <fieldset class="border p-4 space-y-2">
        <legend class="font-semibold">Th√¥ng tin chung</legend>

        <div>
          <label class="block font-medium mb-1">GET_DOCS</label>
          <input type="date" name="GET_DOCS" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">DEC_NO</label>
          <input type="text" name="DEC_NO" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">FACT_NO</label>
          <select name="FACT_NO" class="w-full border rounded px-2 py-1">
            <option></option>
            <option>18A</option>
            <option>B0SZ</option>
            <option>B0M1</option>
            <option>B0M2</option>
          </select>
        </div>
        <div>
          <label class="block font-medium mb-1">LOAI_HINH</label>
          <select name="LOAI_HINH" class="w-full border rounded px-2 py-1">
            <option></option>
            <option>A12</option>
            <option>E21</option>
            <option>H11</option>
          </select>
        </div>
        <div>
          <label class="block font-medium mb-1">FWD</label>
          <input type="text" name="FWD" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">SUPPLIER</label>
          <input type="text" name="SUPPLIER" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">TYPE</label>
          <select name="TYPE" class="w-full border rounded px-2 py-1">
            <option></option>
            <option>CONT</option>
            <option>CFS</option>
            <option>NGOAI_QUAN</option>
            <option>BY_TRUCK</option>
            <option>DHL</option>
            <option>AIR</option>
          </select>
        </div>
        <div>
          <label class="block font-medium mb-1">ORIGIN</label>
          <input type="text" name="ORIGIN" class="w-full border rounded px-2 py-1"/>
        </div>
      </fieldset>

      <!-- Th√¥ng tin v·∫≠n ƒë∆°n -->
      <fieldset class="border p-4 space-y-2">
        <legend class="font-semibold">Th√¥ng tin v·∫≠n ƒë∆°n</legend>

        <div>
          <label class="block font-medium mb-1">BILL_NO</label>
          <input type="text" name="BILL_NO" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">BILL_DATE</label>
          <input type="date" name="BILL_DATE" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">PACKAGES</label>
          <input type="number" name="PACKAGES" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">GW</label>
          <input type="number" name="GW" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">CBM</label>
          <input type="number" name="CBM" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">CTN_NO</label>
          <input type="text" name="CTN_NO" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">ETA_DATE</label>
          <input type="date" name="ETA_DATE" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">ATC</label>
          <input type="date" name="ATC" class="w-full border rounded px-2 py-1"/>
        </div>
      </fieldset>

      <!-- Th√¥ng tin h√≥a ƒë∆°n -->
      <fieldset class="border p-4 space-y-2">
        <legend class="font-semibold">Th√¥ng tin h√≥a ƒë∆°n</legend>

        <div>
          <label class="block font-medium mb-1">INV_NO</label>
          <input type="text" name="INV_NO" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">INV_DATE</label>
          <input type="date" name="INV_DATE" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">AMOUNT</label>
          <input type="text" name="AMOUNT" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="block font-medium mb-1">TERM</label>
          <select name="TERM" class="w-full border rounded px-2 py-1">
            <option></option>
            <option>CIF</option>
            <option>FOB</option>
            <option>C&F</option>
            <option>FCA</option>
            <option>EXW</option>
            <option>CPT</option>
            <option>DAT</option>
            <option>DAP</option>
            <option>CIP</option>
          </select>
        </div>
        <div>
          <label class="block font-medium">File PDF</label>
          <input type="file" id="pdfFile" name="pdfFile" class="w-full border rounded px-2 py-1"/>
        </div>
      </fieldset>

      <div class="md:col-span-3">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded w-full md:w-auto">
          L∆∞u
        </button>
      </div>
    </form>

    <!-- Th√¥ng b√°o k·∫øt qu·∫£ -->
    <div id="addResult" class="mt-4 hidden bg-green-50 border border-green-400 p-4 rounded text-green-700"></div>

  
    <div class="mt-4">
      <label for="pdfUpload" class="block font-medium mb-2">Upload file PDF l√™n Google Drive</label>
      <div class="flex items-center gap-4">
        <input type="file" id="pdfUpload" accept="application/pdf" class="file:mr-4 file:py-2 file:px-4 file:border-0 file:text-sm file:bg-blue-500 file:text-white hover:file:bg-blue-600">
        <button onclick="uploadPDF()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Upload PDF</button>
      </div>
    </div>

    <div id="addResult" class="mt-4 hidden bg-green-50 border border-green-400 p-4 rounded text-green-700"></div>

    <div class="mt-4">
      <button onclick="showTable()" class="text-blue-600 underline hover:text-blue-800">üëâ Xem danh s√°ch</button>
    </div>

    <div class="mt-4 flex gap-2 flex-wrap">
      <button onclick="exportCsv()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">üì§ Xu·∫•t to√†n b·ªô CSV</button>
      <button onclick="exportAtcEmptyCsv()" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">üì§ Xu·∫•t ATC tr·ªëng CSV</button>
    </div>

    <div class="mt-4 flex items-center gap-2">
      <label for="searchDecNo" class="font-medium">T√¨m theo DEC_NO:</label>
      <input id="searchDecNo" type="text" class="p-2 border rounded w-full md:w-1/3" oninput="filterTableByDecNo()" />
    </div>

    <div id="dataTable" class="overflow-x-auto mt-6 bg-white rounded shadow p-4"></div>
  </div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwcj6EZULNWpSXj52mZQgQRNZgqzY50x0JaJlarpoS63OOlDIgfE-NLw-TeFr7NtITW/exec';
let editingIndex = -1;
let fullData = [];

function formatToDMY(isoDate) {
  const [y, m, d] = isoDate.split('-');
  return `${d}/${m}/${y}`;
}

function formatToISO(dmyDate) {
  const [d, m, y] = dmyDate.split('/');
  return `${y}-${m}-${d}`;
}

function uploadPDF() {
  const file = document.getElementById('pdfUpload').files[0];
  if (!file || file.type !== 'application/pdf') return alert('Ch·ªçn file PDF h·ª£p l·ªá');

  const formData = new FormData();
  formData.append('file', file);
  formData.append('action', 'uploadPdf');

  fetch(API_URL, {
    method: 'POST',
    body: formData
  }).then(res => res.json()).then(r => {
    alert('Upload th√†nh c√¥ng: ' + r.url);
  }).catch(err => alert('L·ªói upload: ' + err.message));
}

function exportToCSV(data, filename) {
  const headers = Object.keys(data[0]);
  const csv = [headers.join(',')];
  data.forEach(row => {
    const line = headers.map(h => `"${(row[h] || '').replace(/"/g, '""')}"`).join(',');
    csv.push(line);
  });
  const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

async function exportCsv() {
  const res = await fetch(API_URL);
  const data = await res.json();
  exportToCSV(data, 'full_export.csv');
}

async function exportAtcEmptyCsv() {
  const res = await fetch(API_URL);
  const data = await res.json();
  const filtered = data.filter(row => !row.ATC);
  exportToCSV(filtered, 'atc_empty_export.csv');
}

function showTable() {
  fetch(API_URL).then(res => res.json()).then(data => {
    fullData = data;
    renderTable(data);
  });
}

function renderTable(data) {
  const headers = Object.keys(data[0]);
  let html = '<table class="min-w-full border text-sm"><thead><tr>';
  html += headers.map(h => `<th class="border px-2 py-1 bg-gray-200">${h}</th>`).join('');
  html += '<th class="border px-2 py-1 bg-gray-200">H√†nh ƒë·ªông</th></tr></thead><tbody>';
  html += data.map((row, i) => {
    const cells = headers.map(h => `<td class="border px-2 py-1">${row[h] || ''}</td>`).join('');
    const action = `<td class="border px-2 py-1 text-center">
      <button onclick="editRow(${i})" class="text-blue-600 hover:underline">S·ª≠a</button> |
      <button onclick="deleteRow(${i + 2})" class="text-red-600 hover:underline">Xo√°</button>
    </td>`;
    return `<tr ${editingIndex === i ? 'class="editing-row"' : ''}>${cells}${action}</tr>`;
  }).join('');
  html += '</tbody></table>';
  document.getElementById('dataTable').innerHTML = html;
}

function editRow(index) {
  editingIndex = index;
  const row = fullData[index];
  const form = document.getElementById('importForm');

  form.querySelectorAll('[name]').forEach(input => {
    let val = row[input.name] || '';
    if (input.type === 'date' && val.includes('/')) val = formatToISO(val);
    input.value = val;
  });

  document.getElementById('addResult').innerHTML = `<p class="font-bold text-yellow-700">üõ† ƒêang ch·ªânh s·ª≠a d√≤ng ${index + 2}</p>`;
  document.getElementById('addResult').classList.remove('hidden');
  setFormDisabled(false);
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function deleteRow(index) {
  const item = fullData[index - 2];
  if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën xo√° d√≤ng c√≥ DEC_NO: ${item?.DEC_NO || 'kh√¥ng r√µ'}?`)) return;

  fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'delete', index })
  }).then(r => r.json()).then(result => {
    alert(result.message || 'Xo√° th√†nh c√¥ng!');
    showTable();
  }).catch(err => alert('L·ªói xo√°: ' + err.message));
}

function filterTableByDecNo() {
  const keyword = document.getElementById('searchDecNo').value.toLowerCase().trim();
  const filtered = fullData.filter(row => (row.DEC_NO || '').toLowerCase().includes(keyword));
  renderTable(filtered);
}

function setFormDisabled(disabled) {
  document.querySelectorAll('#importForm input, #importForm select, #importForm textarea, #importForm button[type=submit]')
    .forEach(el => el.disabled = disabled);
}

document.getElementById('addNewBtn').addEventListener('click', () => {
  editingIndex = -1;
  document.getElementById('importForm').reset();
  setFormDisabled(false);
  document.getElementById('addResult').classList.add('hidden');
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

document.getElementById('importForm').onsubmit = async e => {
  e.preventDefault();
  const formData = new FormData(document.getElementById('importForm'));
  if (editingIndex > -1) {
    formData.append('action', 'update');
    formData.append('index', editingIndex + 2);
  } else {
    formData.append('action', 'add');
  }

  try {
    const res = await fetch(API_URL, { method: 'POST', body: formData });
    const result = await res.json();
    document.getElementById('addResult').innerHTML = `<p class="font-bold ${editingIndex > -1 ? 'text-blue-700' : 'text-green-700'}">
      ‚úÖ ${editingIndex > -1 ? 'C·∫≠p nh·∫≠t' : 'Th√™m'} th√†nh c√¥ng!
    </p>`;
    editingIndex = -1;
    document.getElementById('importForm').reset();
    setFormDisabled(true);
    showTable();
  } catch (err) {
    alert('L·ªói g·ª≠i d·ªØ li·ªáu: ' + err.message);
  }
};
</script>
</body>
</html>
