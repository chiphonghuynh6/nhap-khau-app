<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý nhập khẩu</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-screen-xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">Quản lý nhập khẩu</h1>

    <form id="importForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-white p-4 rounded shadow">
      <fieldset class="border p-4">
      <legend class="font-semibold">Thông tin chung</legend>
      <label>GET DOCS <input type="date" class="w-full p-2 border border-black rounded"/></label>
      <label>DEC NO: <input type="text"  class="w-full p-2 border border-black rounded"/></label>
      <label>FACT NO: 
        <select name="FACT no" class="w-full p-2 border border-black rounded"/>
          <option> </option><option>18A</option><option>B0SZ</option><option>B0M1</option><option>B0M2</option>
        </select>
      </label>
      <label>LOẠI HÌNH: 
        <select name="LOẠI HÌNH" class="w-full p-2 border border-black rounded"/>
          <option> </option><option>A12</option><option>E21</option><option>H11</option>
        </select>
      </label>
      <label>FWD: <input type="text" name="FWD" class="w-full p-2 border border-black rounded"/></label>
      <label>SUPPLIER: <input type="text" name="SUPPLIER" class="w-full p-2 border border-black rounded"/></label>
      <label>TYPE: 
        <select name="TYPE" class="w-full p-2 border border-black rounded"/>
          <option> </option><option>CONT</option><option>CFS</option><option>NGOAI QUAN</option>
          <option>BY TRUCK</option><option>DHL</option><option>AIR</option>
        </select>
      </label>
      <label>ORIGIN: <input type="text" name="ORIGIN" class="w-full p-2 border border-black rounded"/></label>
    </fieldset>

    <fieldset class="border p-4">
      <legend class="font-semibold">Thông tin vận đơn</legend>
      <label>BILL NO: <input type="text" name="BILL NO" class="w-full p-2 border border-black rounded"/></label>
      <label>BILL DATE: <input type="date" name="BILL DATE" class="w-full p-2 border border-black rounded"/></label>
      <label>PACKAGES: <input type="number" name="PACKAGES" class="w-full p-2 border border-black rounded"/></label>
      <label>GW: <input type="number" name="GW" class="w-full p-2 border border-black rounded"/></label>
      <label>CBM: <input type="number" name="CBM" class="w-full p-2 border border-black rounded"/></label>
      <label>CTN NO: <input type="text" name="CTN NO" class="w-full p-2 border border-black rounded"/></label>
	  <label>ETA DATEn: <input type="date" name="ETA DATE" class="w-full p-2 border border-black rounded"/></label>
      <label>ATC: <input type="date" name="ATC" class="w-full p-2 border border-black rounded"/></label>
    </fieldset>

    <fieldset class="border p-4">
      <legend class="font-semibold">Thông tin hóa đơn</legend>
      <label>INV NO: <input type="text" name="INV NO" class="w-full p-2 border border-black rounded"/></label>
      <label>INV DATE: <input type="date" name="INV DATE" class="w-full p-2 border border-black rounded"/></label>
      <label>AMOUNT: <input type="number" name="AMOUNT" class="w-full p-2 border border-black rounded"/></label>
      <label>TERM: 
        <select name="TERM" class="w-full p-2 border border-black rounded"/>
          <option> </option><option>CIF</option><option>FOB</option><option>C&F</option>
          <option>FCA</option><option>EXW</option><option>CPT</option>
          <option>DAT</option><option>DAP</option><option>CIP</option>
        </select></label>
      <label>File PDF: <input type="file" id="pdfFile" class="w-full p-2 border border-black rounded"/></label>
	   
      </fieldset>

	<button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded w-full md:w-auto">Thêm lô mới</button>	    
	    
      </form>
	<div class="col-span-full flex flex-col md:flex-row gap-4 mt-4">
  	
  	<button onclick="exportAtcEmpty()" class="bg-green-600 text-white px-4 py-2 rounded w-full md:w-auto">Xuất Excel lô hàng ATC trống</button>
	</div>


    <div id="dataTable" class="overflow-auto bg-white p-4 rounded shadow mt-4"></div>
  </div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwPHGEO8eiGEFUNblt3A9_70P4zYP3M8N1iWk3N4L7-GQZdM2hfl0Eknw8iDQ7TMH1ntw/exec';
let editingIndex = -1;
async function fetchData() {
  const res = await fetch(API_URL);
  const data = await res.json();
  renderTable(data);
}

function renderTable(data) {
  const container = document.getElementById('dataTable');
  const table = document.createElement('table');
  table.className = 'min-w-full border border-gray-300';
  if (data.length === 0) return (container.innerHTML = '<p>Không có dữ liệu.</p>');

  const headers = Object.keys(data[0]);
  table.innerHTML = `
    <thead>
      <tr>${headers.map(h => `<th class='border px-2 py-1 bg-gray-200'>${h}</th>`).join('')}<th>Hành động</th></tr>
    </thead>
    <tbody>
      ${data.map((row, i) => `
        <tr>
          ${headers.map(h => `<td class='border px-2 py-1'>${row[h]}</td>`).join('')}
          <td class='border px-2 py-1'>
  	<button onclick='editRow(${i})' class='text-blue-500 mr-2'>Sửa</button>
  	<button onclick='deleteRow(${i+1})' class='text-red-500'>Xoá</button>
	</td>
        </tr>
      `).join('')}
    </tbody>
  `;
  container.innerHTML = '';
  container.appendChild(table);
}

async function deleteRow(index) {
  if (!confirm('Xác nhận xoá?')) return;
  await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'delete', index })
  });
  fetchData();
}
	
function editRow(index) {
  editingIndex = index;
  const row = document.querySelectorAll("#dataTable table tbody tr")[index];
  const cells = row.querySelectorAll("td");
  const headers = Array.from(document.querySelectorAll("#dataTable table thead th")).map(th => th.innerText);

  // Lặp qua form và điền dữ liệu tương ứng
  const form = document.getElementById("importForm");
  headers.forEach((header, i) => {
    if (header === "Hành động") return;
    const input = form.querySelector(`[name="${header}"]`);
    if (input) input.value = cells[i].innerText;
  });

  // Cuộn lên đầu trang để thấy form
  window.scrollTo({ top: 0, behavior: "smooth" });
}


async function exportAtcEmpty() {
  const res = await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'exportAtcEmpty' })
  });
  const url = await res.text();
  window.open(url, '_blank');
}

// Thêm mới
const form = document.getElementById('importForm');
form.onsubmit = async e => {
  e.preventDefault();
  const formData = new FormData(form);
  const obj = {};
  formData.forEach((v, k) => { if (k !== 'pdfFile') obj[k] = v });

  const file = formData.get('pdfFile');
  let fileData = null;
  if (file && file.size > 0) {
    const b64 = await file.arrayBuffer().then(buf => btoa(String.fromCharCode(...new Uint8Array(buf))));
    fileData = {
      name: file.name,
      mimeType: file.type,
      data: b64
    };
  }

  if (editingIndex > -1) {
    // Sửa
    await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'update', index: editingIndex + 2, data: obj, file: fileData }) // +2 để bỏ header và dùng dòng Google Sheet chính xác
    });
    editingIndex = -1;
  } else {
    // Thêm mới
    await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'add', data: obj, file: fileData })
    });
  }

  form.reset();
  fetchData();
};


fetchData();
</script>
</body>
</html>
